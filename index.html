
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>درصد درگیری دربندی قوطی فلزی</title>
  <style>
    body {
      font-family: Tahoma, sans-serif;
      background: linear-gradient(to bottom, #eef2f7, #ffffff);
      margin: 0; padding: 20px;
      color: #333;
    }
    header {
      background-color: #0077b6;
      color: #fff;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
    }
    .info-text {
      font-size: 14px;
      color: #444;
      text-align: center;
      margin-bottom: 20px;
    }
    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-bottom: 25px;
    }
    .input-row label {
      font-size: 13px;
      display: flex;
      flex-direction: column;
      width: 160px;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .input-row input {
      margin-top: 6px;
      padding: 6px 8px;
      font-size: 14px;
      border: 1px solid #bbb;
      border-radius: 4px;
    }
    .input-row button {
      align-self: flex-end;
      background-color: #0077b6;
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: 0.2s;
      margin-top: 24px;
    }
    .input-row button:hover {
      background-color: #005f99;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #fff;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background-color: #f0f4f8;
      font-weight: bold;
    }
    tbody tr:hover {
      background-color: #f1f9ff;
    }
    #warnings {
      margin-top: 20px;
    }
    #warnings ul {
      list-style: none;
      padding: 0;
    }
    #warnings li {
      background: #fff3f3;
      border: 1px solid #ffcccc;
      padding: 8px 12px;
      margin-bottom: 6px;
      border-radius: 5px;
      color: #c00;
      font-size: 14px;
    }
    .footer-buttons {
      position: fixed;
      left: 20px;
      bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .footer-buttons button {
      width: 130px;
      background-color: #0077b6;
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: 0.2s;
    }
    .footer-buttons button:hover {
      background-color: #005f99;
    }
  </style>
</head>
<body>

<header>
  <h2>برنامه محاسبه درصد درگیری قوطی فلزی v1.01</h2>
  <p>تهیه‌کننده: مصیب خانی - کارشناس کنترل کیفیت</p>
</header>

<p class="info-text">
  🔹 تمام مقادیر ورودی بر حسب <strong>0.001 اینچ</strong> هستند؛
  مقادیر میلی‌متر به صورت مکمل نمایش داده می‌شوند 🔹
</p>

<div class="input-row">
  <label>طول دوخت-SL<input type="number" id="length" min="0" step="0.01"></label>
  <label>ضخامت دوخت-ST<input type="number" id="seamThickness" min="0" step="0.01"></label>
  <label>قلاب درب-CH<input type="number" id="coverHook" min="0" step="0.01"></label>
  <label>قلاب بدنه-BH<input type="number" id="bodyHook" min="0" step="0.01"></label>
  <label>ضخامت ورق سر-Te<input type="number" id="headThickness" min="0" step="0.01"></label>
  <label>ضخامت ورق بدنه-Tb<input type="number" id="bodyThickness" min="0" step="0.01"></label>
  <button onclick="addTemplate()">➕ محاسبه/جدید</button>
</div>

<table id="resultsTable">
  <thead>
    <tr id="headerRow">
      <th>ویژگی‌ها</th>
      <th>قالب 1</th>
    </tr>
  </thead>
  <tbody id="tableBody">
    <tr><td>طول دوخت (Seam Length)</td></tr>
    <tr><td>ضخامت دوخت (Seam Thickness)</td></tr>
    <tr><td>قلاب درب (Cover Hook)</td></tr>
    <tr><td>قلاب بدنه (Body Hook)</td></tr>
    <tr><td>ضخامت ورق سر (End Thickness)</td></tr>
    <tr><td>ضخامت ورق بدنه (Body Thickness)</td></tr>
    <tr><td>اختلاف قلاب (Hook Difference)</td></tr>
    <tr><td>فضای آزاد (Free Space)</td></tr>
    <tr><td>درصد درگیری (Overlap %)</td></tr>
    <tr><td>چروکیدگی قلاب درب</td></tr>
    <tr><td>تیزکردگی دوخت</td></tr>
  </tbody>
</table>

<div id="warnings">
  <strong>⚠️ موارد نیازمند اصلاح:</strong>
  <ul id="warningList"></ul>
</div>

<div class="footer-buttons">
  <button onclick="printReport()">🖨️ پرینت</button>
  <button onclick="saveAsHTML()">💾 ذخیره HTML</button>
</div>

<script>
  let templateCount = 1;

  function toMM(val) {
    return val * 0.0254;
  }

  function formatDualUnit(val) {
    return `${val.toFixed(2)} (${toMM(val).toFixed(2)} mm)`;
  }

  function addTemplate() {
    const ids = ['length','seamThickness','coverHook','bodyHook','headThickness','bodyThickness'];
    const raw = ids.map(id => parseFloat(document.getElementById(id).value));

    if (raw.some(v => isNaN(v) || v < 0)) {
      alert('لطفاً همه فیلدها را با مقادیر عددی مثبت پر کنید.');
      return;
    }

    const [length, seamThickness, coverHook, bodyHook, headThickness, bodyThickness] = raw;
    const hookDiff = Math.abs(coverHook - bodyHook);
    const freeSpace = Math.abs(seamThickness - (3 * headThickness + 2 * bodyThickness));
    const denom = length - (2.2 * headThickness + 1.1 * bodyThickness);
    let overlap = 0;
    if (denom !== 0) {
      overlap = Math.abs((length - (coverHook + bodyHook + 1.1 * headThickness)) / denom * 100);
    }

    if (templateCount > 1) {
      const th = document.createElement('th');
      th.textContent = `قالب ${templateCount}`;
      document.getElementById('headerRow').appendChild(th);
    }

    const values = [
      formatDualUnit(length),
      formatDualUnit(seamThickness),
      formatDualUnit(coverHook),
      formatDualUnit(bodyHook),
      formatDualUnit(headThickness),
      formatDualUnit(bodyThickness),
      formatDualUnit(hookDiff),
      formatDualUnit(freeSpace),
      overlap.toFixed(2),
      '-','-'
    ];

    const rows = document.querySelectorAll('#tableBody tr');
    rows.forEach((r,i) => {
      const td = document.createElement('td');
      td.textContent = values[i];
      td.style.color = '';
      r.appendChild(td);
    });

    const col = templateCount;
    const warnings = [];

    if (coverHook < 70) {
      rows[2].children[col].style.color = 'red';
      warnings.push('قلاب درب کمتر از 70');
    }
    if (bodyHook < 70) {
      rows[3].children[col].style.color = 'red';
      warnings.push('قلاب بدنه کمتر از 70');
    }
    if (hookDiff > 7.8) {
      rows[6].children[col].style.color = 'red';
      warnings.push('اختلاف قلاب بیشتر از 7.8');
    }
    if (freeSpace > 7.5) {
      rows[7].children[col].style.color = 'red';
      warnings.push('فضای آزاد بیشتر از 7.5');
    }

    if (warnings.length) {
      const li = document.createElement('li');
      li.textContent = `قالب ${col}: ${warnings.join('، ')}`;
      document.getElementById('warningList').appendChild(li);
    }

    // پاک‌سازی فرم
    document.getElementById('length').value = '';
    document.getElementById('seamThickness').value = '';
    document.getElementById('coverHook').value = '';
    document.getElementById('bodyHook').value = '';
    document.getElementById('length').focus();

    templateCount++;
  }

  function getReportHTML(name) {
    const tableHTML = document.getElementById("resultsTable").outerHTML;
    const warnHTML = document.getElementById("warnings").outerHTML;
    return `
      <html lang="fa" dir="rtl">
      <head>
        <meta charset="UTF-8">
        <title>گزارش محاسبات قالب</title>
        <style>
          body { font-family: Tahoma, sans-serif; direction: rtl; padding: 20px; }
          table { border-collapse: collapse; width: 100%; margin-top: 10px; }
          th, td { border: 1px solid #000; padding: 6px; text-align: center; }
          h3 { text-align: center; }
          .footer { margin-top: 20px; font-size: 14px; }
        </style>
      </head>
      <body>
        <h3>گزارش محاسبات قالب</h3>
        <p><strong>تاریخ:</strong> ${new Date().toLocaleDateString("fa-IR")}</p>
        ${tableHTML}
        ${warnHTML}
        <div class="footer"><strong>گزارشگر:</strong> ${name}</div>
      </body>
      </html>`;
  }

  function printReport() {
    let name = prompt("نام گزارشگر را وارد کنید:", "مهندس خانی");
    if (!name) name = "مهندس خانی";
    const w = window.open("");
    w.document.write(getReportHTML(name));
    w.document.close();
    w.print();
  }

  function saveAsHTML() {
    let name = prompt("نام گزارشگر را وارد کنید:", "مهندس خانی");
    if (!name) name = "مهندس خانی";
    const blob = new Blob([getReportHTML(name)], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `گزارش_${new Date().toLocaleDateString("fa-IR")}.html`;
    a.click();
    URL.revokeObjectURL(url);
  }
</script>

</body>
</html>
